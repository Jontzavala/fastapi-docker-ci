name: Build, Push, and Deploy Docker Image

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  python-ci:
    name: Python env & dependency check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "requirements.txt"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Sanity check imports
        run: |
          python -c "import fastapi; print('FastAPI OK')"
          python -c "import uvicorn; print('Uvicorn OK')"
      - name: Run tests
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          pytest -q

  docker-validate:
    name: Validate Docker Image
    needs: python-ci
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image for validation
        run: docker build -t fastapi-app-test .

      - name: Run container
        run: docker run -d -p 8000:8000 --name fastapi-test fastapi-app-test

      - name: Wait for container startup
        run: sleep 3

      - name: Test container endpoint
        run: curl -f http://localhost:8000

      - name: Stop container
        run: docker stop fastapi-test

      - name: Remove container
        run: docker rm fastapi-test

  build-and-push:
    needs: docker-validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build Docker image
        run: docker build -t fastapi-app .

      - name: Tag Docker image
        run: docker tag fastapi-app ${{ secrets.DOCKER_USERNAME }}/fastapi-demo:latest

      - name: Push Docker image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/fastapi-demo:latest

  deploy:
    name: Deploy to EC2
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH to EC2
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }} # e.g. 54.235.231.28
          username: ${{ secrets.EC2_USER }} # e.g. ubuntu
          key: ${{ secrets.EC2_SSH_KEY }} # contents of your .pem
          port: ${{ secrets.EC2_PORT }} # usually 22
          envs: DOCKER_USERNAME,DOCKER_PASSWORD,APP_ENV
          script: |
            # Log in to Docker Hub
            echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin

            # Pull latest image
            docker pull ${DOCKER_USERNAME}/fastapi-demo:latest

            # Stop & remove old container if it exists
            docker stop fastapi-app || true
            docker rm fastapi-app || true

            # Run new container
            docker run -d \
              --name fastapi-app \
              --restart unless-stopped \
              -p 8000:8000 \
              -e APP_ENV=${APP_ENV} \
              ${DOCKER_USERNAME}/fastapi-demo:latest

            # Health check
            sleep 3
            curl -f http://localhost:8000 || (echo "Health check FAILED" && docker logs fastapi-app --tail 50 && exit 1)
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          APP_ENV: ${{ secrets.APP_ENV }}
